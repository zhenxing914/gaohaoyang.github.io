## 1. 对比范式建模与维度建模

### 1. 范式建模

该⽅方法的主要由 Inmon 所提倡，主要利利⽤用关系型数据库进⾏行行数据仓库的建设，且模型的建设⽅方法和业务 系统的数据模型⽐比较类似

经典范式理理论中，一个符合第三范式的关系必须具有以下三个条件 :

- 1NF：每个属性值唯⼀，不具有多义性 ;
- 2NF：每个⾮非主属性必须完全依赖于整个主键，而非主键的一部分 ; 
- 3NF：每个⾮非主属性不不能依赖于其他关系中的属性。 



**优点：**

• 节约存储 
• 结构清晰 
• 易易于理理解 
• 适合关系型数据库 



**缺点:**
 • 构建⽐比较繁琐 
 • 查询复杂 
 • 不不适合构建在⼤大数据分布式环境下 



虽然有这些缺点，但是范式建模的理理论，仍然是需要我们去熟练掌握。原因有如⼏几点:

- 数据仓库的上游有相当⼀一部分数据源是业务数据库，而这些业务数据库，其理理论一般基于范式理理论 

- 数据源的规范定义需要我们了了解范式理理论。

- 数据仓库下游系统⽐比如报表系统设计时，可能会⽤用到范式理理论。



### 2. 维度建模

由于存在上述的问题，Kimball根据⾃自⼰己的经验，提出的维度建模的理理论，即数据都可以抽象成事实和维 度，维度为观察事物的⻆角度，事实为对应某粒度下的度量量值，⼀一般，维度建模的步骤如下:

**1. 选择业务过程** 

业务过程是一系列操作活动，转换为事实表中的事实，例如每个⽉每个账单快照

**2.声明粒度** 

粒度是指事实表中的一⾏代表什么。同一事实表不要混用粒度，最好从最小粒度开始设计维度，因其能承受用户⽆无法预知的查询需求。

 **3.确认维度**

维度是根据粒度将表分开成多个维度表，即从不不同维度(⻆角度)去看。

维度是数据仓库的灵魂，是BI的入口和驱动 

**4.确认事实**

事实是指一种在某个粒度下的度量，例如在销售维度中，销量和总额是良好的事实，而商店经理理的⼯资则不不允许出现在该维度中。



优点: 

- ⽅便使⽤用

- 适合大数据下的数据处理 

- 适合进行OLAP操作  

缺点:

- 维度补全造成的数据存储的浪费  

- 维度变化造成的数据更更新量量⼤大  

- 与范式理理论差异很⼤大，是典型的反三范式 



## 2. 再谈维度建模的四个步骤

### 1. 维度建模步骤

维度建模的四个步骤，分别是:

1. **选择业务过程**

业务过程是一系列操作活动，转换为事实表中的事实，例如每个月每个账单快照

2. **声明粒度**

粒度是指事实表中的⼀行代表什么。同⼀事实表不要混⽤粒度，最好从最小粒度开始设计维度，因其能承受用户⽆法预知的查询需求。

3. **确认维度**

维度是根据粒度将表分开成多个维度表，即从不同维度(⻆角度)去看。

维度是数据仓库的灵魂，是BI的⼊口和驱动

4. **确认事实**

事实是指一种在某个粒度下的度量，例如在销售维度中，销量和总额是良好的事实，而商店经理理的工资则不允许出现在该维度中。



### 2. 案例

​		假设我们要构建的是⼀张订单表，那业务过程即为这个具体是哪种业务场景下的订单数据，粒度即为该表 中的每一条数据具体是细化到如何的程度，是一条数据代表⼀个订单还是多个订单，维度即为该订单有哪些的附属信息，比方说订单类型、支付方式、城市信息、日期信息等等，那事实是指具体的订单量的数值。

那么，我们可以假设，这个订单表的基础信息包括:

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdcx9pwk3rj30fw0aw76m.jpg" alt="image-20200331105338418" style="zoom:50%;" />

**业务过程**:  用户购买商品的订单记录表 

**申明粒度**: 每一条记录代表一个有效订单 

**确认维度**: 商户维度、用户维度、支付维度、收货维度 

**确认事实**: 订单总金额



当然实际我们在构建数据表时，会有多个这样的数值。

通过对不不同的维度进⾏行行统计组合，我们就会得到一个多维数据集，来从多⻆角度观察我们的业务过程的好坏情况。

 



## 3. 事实表的基本概念

### 1. 度量

事实表中的度量主要分为三种:可加、半可加、不不可加 。

- 可加的度量

  ⾔言外之意，既可以在任意维度下进⾏行行累加，例例如订单中的订单金额，商品数量等 

- 半可加的度量

  即为有的时候可以累加，有的时候不可以累加，学⽣生成绩表中的各科⽬目的成绩，针对每个人是可以进⾏累加，但是全班进行累加，是没有任何意义的 

- 不可加的度量

  即为任何场景下均不可累加，典型的⽐如⽐例或者比率，其只针对单⾏行行记录有意义，直接累加⽆无意义	

### 2. 一致性

⼀致性可以有两层的理理解，⼀是表内部的⼀致性，二是表与表之间的一致性

- 表内部的一致性是指: 

  在同⼀个表内部，所有记录的粒度、维度等信息均是一致的，每一列的单位，枚举值等均是一致

- 表与表之间的⼀致性是指：

  如果我们在进⾏行行多个表的数据合并时，应该保证彼此之间的对于同一事实的计算，是在同一粒度和维度之下。





## 4. 常见的事实表类型

### 1. 事务事实表

事务事实表的一⾏，对应空间或时间上某点的度量量事实。在实际的使⽤用中，其⼀一般作为明细成使⽤用，即记录业务系统中的事务⾏行行明细数据，⽐如出⾏行业中典型的下单明细表、推单明细表、抢单明细表、⽀支付明细 表等，基本每⼀个表对应⼀个典型的事件类型，这类表记录了了业务最明细的数据。

### 2. 周期快照事实表

周期快照事实表中的每⼀⾏发⽣在某一标准周期，⽐如某⼀天、某周、某⽉的多个度量事件。最典型的 周期快照事实表为，每⽇日仓库库存快照表、每⽇日⽤用户余额快照表，这些快照表是对当⽇日最后时刻的快照统 计，当然这个快照的具体时间，实际上是与当时抽取的时间点有关系，并⾮非绝对意义上的0点

### 3. 累积快照事实表

累积快照事实表的⾏行行汇总了了发⽣生在过程开始和结束之间可预测的步骤内的度量量事件。以事务事实表中的提 到的出⾏行业的例例子为例，可以做⼀一个和订单相关，涉及订单下单、推单、抢单、⽀支付等各个环节的⼀一张订单全⽣生命周期快照表。累积快照事实表与周期快照事实表最⼤大的不不同在于累积快照事实表其实是有多个业务 过程的时间节点的，⽽而这些节点可能不不是在⼀一个时间点同时完成。

### 4. 无事实的事实表

单纯只记录某⼀一动作发⽣生，其事件的量量化是⾮非数字的，⽐比较典型的为访问点击⽇日志。这些⽇日志，如果作为 明细成数据，只是单纯记录了了⽤用户的点击⾏行行为或者浏览⾏行行为。当然我们可以对这些数据进⾏行行很多统计，只是 这些记录本身是没有度量量值的

### 5. 聚集事实表

聚集事实表是对原⼦子粒度事实表进⾏行行简单的数字化上操作，直观理理解可以为进⾏行汇总，这样在进⾏行行查询时可以提⾼高效率。

实际我们在⼯工作过程中，处理理进⾏行行简单的汇总操作，也会构建⼀一个CUBE表，讲不不通维度的数据组合在一 张表中，相当于提前进⾏行行各种维度的预计算，并将这些数据提供给下游系统使⽤用。



## 5. 维度表的基本概念

### 1. 一致性

当不同的维度表的属性具有相同列名和领域内容时，称维度表具有一致性。

利用一致性维度属性与每个事实表关联，可将来⾃不同事实表的信息合并到同一个报表中。

直观理理解:即为各数据仓库或者集市维护同⼀份维度表，⽐比如常⽤用的城市信息，渠道信息，支付方式信息，用户基础信息等等，当我们的上层应⽤需要从不同的集市获取不同的指标进行组合时，在维度⼀致的情 况下，其组合才有意义。这种情况特别体现在跨报表合并时



## 6. 常见的维度表类型

### 1. 缓慢变化维(SCD)

维度的属性并不不是静态的，会随着时间的流逝发⽣生缓慢的变化。这种随着时间流逝的维度，我们⼀一般称之 为缓慢变化维，并且把处理理维度表的历史变化信息的问题称为处理理缓慢变化维的问题。

常⻅见的处理理⽅方式有五种:

- Type1: 直接覆盖。

  常⻅见的场景如个⼈人的余额

- Type2: 拉链表⽅式。

  通过添加记录来讲每⼀一次变化都记录到SCD中，每条记录都有三个字段，如start_time，end_time 表名有效期，设定⼀一个active_flag的布尔型字段，⽤用来标识该字段是否为最新的状态 

- Type3: 添加属性列列，来记录最近变化⽽而⾮非全部变化 

- Type4: 新建⼀个表来保存历史记录。即为Type1和Type2的混合 

- Type5: 即为Type1/Type2/Type3的混合。

  在实际的工作中，如果使用的是大数据(比如Hive)，有时候也会使⽤用分区表每⽇一个快照的⽅方式来保留留这些维表的历史状态，一般以天为单位来进⾏行行保留留。由于这些快照是以天为单位，一天之内发⽣生的变化就不不发 记录下来了。

### 2. 退化维

退化维是指只有编号，但是不需要单独的维表的维度，比如订单编号、支付编号等，属于一种特殊的维度

### 3. 微型维度

​		微型维度是指从⼤大型维表中提取出来的常⽤用的维度，独⽴立成一个维表的维度，这类型的维度和具体的业务紧密结合。比如，我们统计⽤户常⽤的应⽤用下载列列表TOP10，只需要维护一张日常使用的应用维表即可，⽽全量的应⽤用维表可能是数以千万计的。

### 4. 杂项维度

​		杂项为是指一些⾮常规的维表，其数据量很⼩小，不⽤独立成维表，这些维表我们可以统一存放在一张表 中。一般这类型维表的存放⾄少包括三个字段信息:维度类型type，维度key，维度value。用户可以根据不同的维度type获取⾃己需要的维度。

### 5. 日期维度

连接到实际事实表的日期维度，使得能够对事实表，按照熟悉的⽇日期、⽉月份、财务周期、节假⽇日等进⾏行行 导航。常⻅见的⽇日期维度的值有:
```
1. 日期
2. 周几
3. 第几周
4. 第几季度
5. 第⼏个⽉
6. 第⼏年
7. 节假⽇
8. 。。。
```
日期维度往往需要⼿工提前维护，有些字段例如周数，是存在不同的算法，所以如果有统一的日期维度， 就可以很好的进行统⼀。



## 7.数据分层的意义

- 清晰数据结构

  每⼀一个数据分层都有它的作⽤用域和职责，在使⽤用表的时候能更更⽅方便便地定位和理理解 

- 减少重复开发

  规范数据分层，开发一些通⽤的中间层数据，能够减少极大的重复计算 

- 统⼀数据⼝径

  通过数据分层，提供统一的数据出口，统一对外输出的数据口径 

- 复杂问题简单化

  将⼀个复杂的任务分解成多个步骤来完成，每一层解决特定的问题 



## 8.经典分层论讲解

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gddzvk9jhcj31340fgqa2.jpg" alt="image-20200331165446677" style="zoom:67%;" />



## 9.分层的边界

### 1. ODS层

​		数据接⼊入层，也叫ODS层，是最接近数据源中数据的一层，数据源中的数据，经过抽取、洗净、传输，也就说传说中的 ETL 之后，装⼊本层。本层的数据，总体上⼤多是按照源头业务系统的分类⽅式⽽分类的。

​		⼀般来讲，为了了考虑后续可能需要追溯数据问题，因此对于这一层就不建议做过多的数据清洗工作，原 封不动地接入原始数据即可，⾄于数据的去噪、去重、异常值处理理等过程可以放在后面的DWD层来做。

### 2. DWD层

​		该层一般保持和ODS层一样的数据粒度，并且提供一定的数据质量保证。同时，为了了提⾼高数据明细层的易易⽤用性，**该层会采⽤用⼀些维度退化手法，将维度退化⾄至事实表中，减少事实表和维表的关联。**

### 3. DWS层

​		该层会在DWD层的数据基础上，对数据做轻度的聚合操作，生成⼀系列的中间表，提升公共指标的复⽤用性，减少重复加工。 直观来讲，就是对通用的核⼼维度进行行聚合操作，算出相应的统计指标。

### 4. DWM层

​		又称数据集市或宽表。按照业务划分，如流量、订单、用户等，⽣成字段⽐较多的宽表，用于提供后续的业务查询，OLAP分析，数据分发等。

​		一般来讲，该层的数据表会相对比较少，一张表会涵盖比较多的业务内容，由于其字段较多，因此⼀一般也会称该层的表为宽表。

### 5.  APP层

在这里，主要是提供给数据产品和数据分析使⽤的数据，一般会存放在 ES、PostgreSql、Redis等系统中供线上系统使用，也可能会存在 Hive 或者 Druid 中供数据分析和数据挖掘使⽤用。比如我们经常说的报表数据，一般就放在这里。



## 10. 数据的流向

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gddzxgmxjsj30uy0jyakk.jpg" alt="image-20200331170534066" style="zoom:50%;" />

数据流向的基本原则:
- 禁⽌逆向调⽤

  所有的数据流向都是从接⼊入层->中间层->应⽤用层 

- 避免跨层调⽤

  在进⾏行模型设计时，尽量在模型上避免出现跨层调用，但是也允许根据实际情况进⾏行跨层的处理理

- 避免同层调⽤

  不不做硬性的要求，尽量量在模型上保持保持模型的有序 

- 优先使⽤公共层/中间层数据

  中间层已经存在的数据或者指标，不不允许进⾏行行重复的加⼯工，应该优先 使⽤用这部分已经存在的数据 



## 11. 数据架构之lambda与kappa架构

### 1. lambda架构

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gddzvt7h7ej30rw0f8n5a.jpg" alt="image-20200331170837957" style="zoom:50%;" />

**主要特点**

主要分为批处理理层、实时流层、服务层，其中批处理理层主要进⾏行行离线处理理，实时流层主要进⾏行行实时数据处理理， 服务层合并两者结果数据统一对外提供服务。

**优点：**

1. 稳定 

   ⽬目前有相当⼀一部分的数据仓库的架构采取这样的⽅方式，原因在于批处理理和实时处理理是分开的，分别处理理不不同频率的数据，双链路路也保证了了整个数据的稳定性

2. 技术实现难度低、开发成本⼩小 

   这类型的架构⽐比较适合进⾏行行需求的版本迭代，先离线满⾜足需求，再通过实时链路路完善数据的实时性，两者可以分版本上线。在实际的⽣生产环境中，⼀一般只会在部分场景使⽤用实时流技术进⾏行行开发，开发成本相对⽐比较低

3. 数据回溯相对⽐比较容易易 

   当上游数据出现异常时，可以通过批处理理进⾏行行数据的快速恢复，并覆盖错误的数据

**缺点：**

1. 统计口径不一致问题

   由于两条链路路本身是独立的，⽽且多半是由不不同的⼈分阶段进⾏行开发，难免会造成统计口径不⼀致。我们在前⾯面的PPT中提到，在构建事实表时需要遵从⼀一个规则，多种数据在进⾏行行合并时，必须遵从一致性原则。如果两者统计⼝口 径不不一致，就会导致整个数据被污染，变得不不可⽤用，甚⾄至影响到业务决策

2. 代码冗余

    同样的代码逻辑，在批处理链路实现一次，在流处理上再次处理⼀次，从代码管理理上，完全是多余的

3. 零点切换问题

    一般情况下，离线负责历史数据统计，实时负责当⽇日数据的统计。在零点时，问题出现了了，离线链路路一般是T+1，在零点附近的⼏几个⼩小时内，离线链路路还没有处理理完数据，这个时候会出现在应⽤用层⽆无法获取到昨⽇日的数据，只有前天和今天的数据。

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdd87unm7sj30vq0ea12k.jpg" alt="image-20200331170948352" style="zoom:50%;" />

一般处理理这种情况，可以取最近今⽇日和昨⽇日的实时数据+昨⽇日之前的离线数据构成全量量数据，即

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdd87y2j5hj30va05s0uk.jpg" alt="image-20200331171036876" style="zoom:50%;" />



### 2. kappa结构

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gddzvzfo07j30va0c20z8.jpg" alt="image-20200331171056892" style="zoom:50%;" />

**主要特点:**

只使⽤实时数据作为数据处理理层，统⼀离线和实时链路。

**优点：**

1. 整体数据链路路清晰 

   由于去掉了了批处理理层，基本只保留留实时层，架构简单清晰

2. 规避统计⼝径不不一致问题

    因为只有一条单一的链路路，也就不不存在统计⼝口径不不⼀一致问题

3. 无零点问题

    应⽤用层不不需要进⾏行行数据merge，零点可以平滑切换

**缺点：**

1. 回溯数据成本比较大

    回溯数据必须要重新进⾏行行消息的消费，且需要清理理历史数据，想⽐比较批处理理⽽而⾔言，成本会⽐比较⾼高

2. 开发周期⽐较长

    相⽐比较批处理理⽽而⾔言，流处理理⽬目前的实现语⾔言主要以Scala和Java为主，一般开发周期要⻓长于使⽤用如Hive SQL ⽅方式进⾏行行开发，不不过⽬目前很多的流处理理框架也⽀支持SQL，但是部分函数还⽀支持的不不是很好

3. 机器成本问题 

   一般流处理理数据所耗费的机器器成本会更更高一些，会⼤量用到⼀些⾮结构化存储，且任务常驻内存。



### 3. 混合架构

​		混合架构即是讲这两种架构结合起来使用，针对不同的场景使用不同的架构。目前实际的工作中，两种架构都会用到，那么两种架构到底孰优孰劣，还是要根据实际情况进行选择。

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gdd86thv7pj30hi08640g.jpg" alt="image-20200331171207063" style="zoom:50%;" />

项⽬三⻆形:范围、时间、成本、质量，彼此之间寻求一个平衡。

- 如果你的数据本身不不太要求实时性，那么单独的批处理理链路路即可，

- 如果要求⼀定的实时性，就可以采⽤用 Lambda架构，但是团队成员需要有一定的实时流处理理开发能力。

- 如果业务对实时性要求⾮非常⾼高，那么这个时 候应该讲流处理理的能力摆在第一位，批处理理作为⼀一个补充。

所有这些，都是为了了保证最终的数据产出的质量量。



## 12. 典型的数据流设计思路

### 1. 总体设计

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gddzw67jsqj30t60fcwlx.jpg" alt="image-20200331172217831" style="zoom:67%;" />

### 2. 批处理

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gddzw8mu19j30us0gkdo5.jpg" alt="image-20200331172239019" style="zoom:67%;" />

### 3. 流处理

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gddzwf5jxsj30us0gkgt4.jpg" alt="image-20200331172254818" style="zoom:67%;" />





## 13. 数据服务业务的几种方式

### 1. 经营分析报表

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gddzwv3ixij317u0u0q8r.jpg" alt="image-20200331172720797" style="zoom:67%;" />

主要形式: 

- For管理理层:宏观分析报表

- For中⾼高层:各业务主要指标监控

-  For⼀一线运营:具体业务的明细报表

其中，这些数据多以数据可视化的⽅方式进⾏展示。

### 2. 多维分析和自助画查

<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gddzx2ipq3j30m20e876p.jpg" alt="image-20200331172829659" style="zoom:50%;" />

常⻅见的应⽤用场景: 

1、提供基于SQL的自助查询工具 

2、通过托拉拽组件化⽅方式提供维度与指标的任意组合，这⾥⼜分为预计算和基于明细数据实时统计两种⽅方式

3、基于以上两种技术衍⽣出来的自助提数/提包工具等 

4、基于以上两种技术衍⽣出来的⽤户画像分布工具等



### 3. 服务化和产品化

服务化和产品化的最终目的是数据价值的放大器，而服务化和产品化本身已经不仅仅包含数据研发，而是和数据分析，数据产品，可视化，设计紧密结合的。数据中台的这一概念的出现，其本质就是数据的服务化和产品化。
 典型的如:

1、IDMapping服务(支持各类型设备与账号的互转) 

2、⽤户画像服务(For⼴告/推荐等场景) 

3、DMP(Data Management Platform)数据管理理平台 

4、ADS⼴广告投放平台(阿里妈妈、广点通、凤巢等)







