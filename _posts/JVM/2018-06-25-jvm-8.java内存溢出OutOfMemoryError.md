---
layout: post
title:  "java内存区域与内存溢出-3.java内存溢出OutOfMemoryError"
categories: "jvm"
tags: "jvm"
author: "songzhx"
date:   2018/06/25 17:45:21 
---

## Java堆溢出

Java堆用于存储对象实例，只要不断地创建对象，并且保证GC Roots到对象之间有可达路径来避免垃圾回收机制清除这些对象，那么在对象数量达到最大堆的容量限制后就会产生内存溢出异常。



## 虚拟机栈和本地方法栈溢出

栈容量只有-Xss参数设定。关于虚拟机栈和本地方法栈，在java虚拟机规范中描述了两种异常：

+ 如果线程请求的栈深度大雨虚拟机所允许的最大深度，将抛出StackOverFlowError异常。

+ 如果虚拟机在扩展栈时无法申请到足够的内存空间，则抛出OutOfMemoryError异常。

  操作系统分配给每个进程的内存是有限制的，譬如32位的windows限制为2G。虚拟机提供了参数来控制java堆和方法区的着两部分内存的最大值。剩余的内存为2GB减去Xmx(最大堆内存)，再减去MaxPermSize（最大方法区容量），程序计数消耗内存很小，可以忽略掉。如果虚拟机本身消耗的内存不计算在内，剩下的内存就由虚拟机栈和本地方法栈“瓜分”了。

如果建立多线程的导致的内存溢出，在不能减少线程数或者更换64位虚拟机的情况下，就只能通过减少最大堆和减少栈容量来换取更多的线程。



## 方法区和运行时常量池溢出

方法区用于存放Class的相关信息，如类名、访问修饰符、常量池、字段描述、方法描述等。基本的思路是运行时产生大量的类区填充方法区，直到溢出。



## 本地直接内存溢出

DirectMemory容量可通过-XX:MaxDirectMemorySize指定，如果不指定，则默认与Java堆最大值（-Xmx指定）一样。

由于DirectMemory导致的内存溢出，一个明显的特征是在HeapDump文件中不会看到明显的异常，如果发现OOM之后Dump文件很小，而程序中又直接或间接使用了NIO，那就可以考虑检查一下是不是这方面的原因。